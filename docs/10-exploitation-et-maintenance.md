# 10 — Exploitation et maintenance

## Rôle du document

Décrire comment opérer le MVP en production (mono-instance sur VPS OVH, Docker/Compose, persistance fichiers), comment diagnostiquer les problèmes et quelles routines minimales appliquer.

## Sources

- `docs/06-architecture-technique.md`
- `docs/09-cicd-et-deploiement.md`
- `clarifications/06-deploiement-et-hebergement.md`

## 1. Cible de production (rappel)

- Hébergement : VPS OVH (Linux).
- Déploiement : Docker obligatoire, Docker Compose.
- Topologie : 1 service (Express sert l’API + le front buildé).
- HTTPS : requis.
- Terminaison HTTPS (décision id001) : Nginx (host) + Certbot/Let’s Encrypt, hostname `space-invader.jlg-consulting.com`.
- Persistance : bind mount Docker pour `server/data/`.
- Environnements : prod uniquement.
- Sauvegardes : aucune (MVP).

## 2. Artefacts & configuration runtime

### 2.1 Fichiers critiques

- Fichiers de données : `server/data/` (bind mount).
- Fichier de scores : ex `server/data/scores.json`.

### 2.2 Variables (rappel)

- `PORT`
- `DATA_DIR`
- `NODE_ENV=production`

## 3. Procédure de déploiement (MVP)

Objectif : déployer une nouvelle version sans perdre les données.

- Pré-requis : `server/data/` pointant vers un dossier persistant sur le VPS.
- Étapes (conceptuelles) :
  1. Pull de la nouvelle image (ou copie du nouvel artefact).
  2. Redémarrage du service via Compose.
  3. Vérification : page d’accueil OK + `GET /api/leaderboard/day` OK.
  4. Vérification HTTPS : certificat valide, redirection HTTP→HTTPS OK.

## 4. Supervision et diagnostics

### 4.1 Signaux à surveiller

- Disponibilité HTTP (site accessible).
- Erreurs 5xx (API score / leaderboard).
- Taille du fichier `scores.json` (croissance continue).

### 4.2 Logs

- Source : stdout/stderr du conteneur.
- À tracer a minima :
  - démarrage serveur,
  - erreurs de validation input,
  - erreurs lecture/écriture JSON,
  - erreurs inattendues (catch-all).

## 5. Gestion des incidents (runbook léger)

### 5.1 Le site ne répond plus

- Vérifier : conteneur up, ports exposés, reverse proxy HTTPS (si utilisé).
- Actions : redémarrer le service, consulter logs.

Si terminaison HTTPS via Nginx (cas normal) :

- Vérifier : service Nginx actif, vhost `space-invader.jlg-consulting.com` chargé, ports 80/443 ouverts.
- Vérifier : statut Certbot et dates d’expiration du certificat.

### 5.2 Enregistrement des scores en erreur

- Vérifier : permissions du dossier bind mount, espace disque, corruption JSON.
- Actions :
  - sauvegarder le fichier actuel,
  - réparer/restaurer un JSON valide si nécessaire,
  - redémarrer.

### 5.3 Classement vide “alors qu’il y a des scores”

- Vérifier : calcul `dayKeyParis` / timezone Europe/Paris.
- Vérifier : date système VPS (NTP).

## 6. Données & maintenance

### 6.1 Croissance des données

- Risque MVP : `scores.json` grossit sans limite.
- Mitigation possible (post-MVP) :
  - partitionner par mois (`scores-YYYY-MM.json`),
  - compaction/archivage.

### 6.2 Sauvegardes

- Décision actuelle : aucune (MVP).
- Recommandation (quand on voudra sécuriser) : snapshot quotidien du dossier `server/data/`.

## 7. Sécurité (minimum)

- HTTPS requis.
- Pas d’admin endpoint.
- Limiter taille payload JSON.
- Patcher régulièrement l’image Node (dépendances).

Décisions complémentaires (id001) :

- Pare-feu : autoriser uniquement SSH + HTTP + HTTPS.
- Redirection : HTTP→HTTPS.
- HSTS : activé (choisir une durée prudente au début).
- Certificats : renouvellement automatisé via Certbot (timer systemd ou tâche planifiée).

## 8. Évolutions post-MVP (pistes)

- Ajout d’un endpoint healthcheck.
- Ajout de sauvegardes automatiques.
- Rotation/partition des fichiers de scores.
- Déploiement staging (si besoin).
